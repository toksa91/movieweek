import streamlit as st
import pandas as pd
import numpy as np
import io

# Set page configuration
st.set_page_config(
    page_title="MovieWeek",
    layout="wide",
)

# App title and description
st.title("ğŸ¬ MovieWeek")
st.markdown("ìš”ì¼ë³„ ì˜í™” ê´€ëŒê° íŒ¨í„´ì„ ë¶„ì„í•˜ê³  ì‹œê°í™”í•˜ëŠ” ì›¹ ì•±ì…ë‹ˆë‹¤.")

try:
    # GitHub URLì—ì„œ ì§ì ‘ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    # 'data.csv' íŒŒì¼ì˜ raw URL
    url = 'https://raw.githubusercontent.com/toksa91/movieweek/main/data.csv'

    # CSV íŒŒì¼ì˜ í—¤ë”ê°€ ë¶ˆê·œì¹™í•˜ë¯€ë¡œ, ì§ì ‘ ì»¬ëŸ¼ëª…ì„ ì§€ì •í•˜ê³  ë¶ˆí•„ìš”í•œ ìƒë‹¨ í–‰ì„ ê±´ë„ˆëœë‹ˆë‹¤.
    columns = ['ìˆœìœ„', 'ì˜í™”ëª…', 'ê°œë´‰ì¼', 'ë§¤ì¶œì•¡', 'ë§¤ì¶œì•¡_ì ìœ ìœ¨', 'ë§¤ì¶œì•¡ì¦ê°', 'ë§¤ì¶œì•¡ì¦ê°ìœ¨', 'ëˆ„ì ë§¤ì¶œì•¡',
               'ê´€ê°ìˆ˜', 'ê´€ê°ìˆ˜ì¦ê°', 'ê´€ê°ìˆ˜ì¦ê°ìœ¨', 'ëˆ„ì ê´€ê°ìˆ˜', 'ìŠ¤í¬ë¦°ìˆ˜', 'ìƒì˜íšŸìˆ˜', 'ëŒ€í‘œêµ­ì ',
               'êµ­ì ', 'ì œì‘ì‚¬', 'ë°°ê¸‰ì‚¬', 'ë“±ê¸‰', 'ì¥ë¥´', 'ê°ë…', 'ë°°ìš°']
    df = pd.read_csv(url, encoding='cp949', skiprows=8, names=columns)

    st.success("ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!")
    st.subheader("ğŸ“Š ë°ì´í„° ë¶„ì„ ë° ì‹œê°í™” ê²°ê³¼")

    # í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ
    req_cols = ['ê°œë´‰ì¼', 'ì˜í™”ëª…', 'ê´€ê°ìˆ˜', 'ë§¤ì¶œì•¡']
    if 'ì¥ë¥´' in df.columns:
        req_cols.append('ì¥ë¥´')
    df = df[req_cols].copy()

    # ì»¬ëŸ¼ëª… í†µì¼
    df.rename(columns={'ê°œë´‰ì¼': 'ë‚ ì§œ'}, inplace=True)

    # ë‚ ì§œ ë³€í™˜ & ìš”ì¼ ìƒì„±
    df['ë‚ ì§œ'] = pd.to_datetime(df['ë‚ ì§œ'], errors='coerce')
    df.dropna(subset=['ë‚ ì§œ'], inplace=True)
    weekdays = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼']
    df['ìš”ì¼'] = df['ë‚ ì§œ'].dt.weekday.apply(lambda x: weekdays[x])

    # ê´€ê°ìˆ˜ ì²˜ë¦¬
    df['ê´€ê°ìˆ˜'] = df['ê´€ê°ìˆ˜'].astype(str).str.replace(',', '', regex=False)
    df['ê´€ê°ìˆ˜'] = pd.to_numeric(df['ê´€ê°ìˆ˜'], errors='coerce').fillna(0).astype(int)

    # ë§¤ì¶œì•¡ ì²˜ë¦¬
    df['ë§¤ì¶œì•¡'] = df['ë§¤ì¶œì•¡'].astype(str).str.replace(',', '', regex=False)
    df['ë§¤ì¶œì•¡'] = pd.to_numeric(df['ë§¤ì¶œì•¡'], errors='coerce').fillna(0).astype(int)

    # ===============================
    # ìš”ì¼ë³„ ì´/í‰ê·  ê´€ê°ìˆ˜
    # ===============================
    total_audience_by_day = df.groupby('ìš”ì¼')['ê´€ê°ìˆ˜'].sum().reindex(weekdays)
    daily_average_audience = df.groupby('ìš”ì¼')['ê´€ê°ìˆ˜'].mean().reindex(weekdays)

    # ===============================
    # ìš”ì¼ë³„ ìµœëŒ€/ìµœì†Œ ì˜í™”
    # ===============================
    max_audience_by_day = df.loc[df.groupby('ìš”ì¼')['ê´€ê°ìˆ˜'].idxmax()][['ìš”ì¼', 'ì˜í™”ëª…', 'ê´€ê°ìˆ˜']]
    min_audience_by_day = df.loc[df.groupby('ìš”ì¼')['ê´€ê°ìˆ˜'].idxmin()][['ìš”ì¼', 'ì˜í™”ëª…', 'ê´€ê°ìˆ˜']]

    # ===============================
    # Streamlit columns: ì´/í‰ê·  ê´€ê°ìˆ˜
    # ===============================
    col1, col2 = st.columns(2)

    with col1:
        st.markdown("### **ìš”ì¼ë³„ ì´ ê´€ê° ìˆ˜**")
        st.bar_chart(total_audience_by_day)
    with col2:
        st.markdown("### **ìš”ì¼ë³„ í‰ê·  ê´€ê° ìˆ˜**")
        st.line_chart(daily_average_audience)

    # ===============================
    # ìš”ì¼ë³„ ìµœëŒ€/ìµœì†Œ ì˜í™” í‘œì‹œ
    # ===============================
    st.markdown("### **ìš”ì¼ë³„ ìµœëŒ€ ê´€ê° ì˜í™”**")
    st.dataframe(max_audience_by_day.set_index('ìš”ì¼'))

    st.markdown("### **ìš”ì¼ë³„ ìµœì†Œ ê´€ê° ì˜í™”**")
    st.dataframe(min_audience_by_day.set_index('ìš”ì¼'))

    # ===============================
    # ì¥ë¥´ë³„ ìš”ì¼ ê´€ê°ìˆ˜ (ì„ íƒì )
    # ===============================
    if 'ì¥ë¥´' in df.columns:
        st.markdown("### **ì¥ë¥´ë³„ ìš”ì¼ ê´€ê° ìˆ˜**")
        genre_day = df.groupby(['ì¥ë¥´', 'ìš”ì¼'])['ê´€ê°ìˆ˜'].sum().unstack(fill_value=0).reindex(columns=weekdays, fill_value=0)
        st.dataframe(genre_day)
        st.markdown("#### **ì¥ë¥´ë³„ ìš”ì¼ ê´€ê°ìˆ˜ ë§‰ëŒ€ ì°¨íŠ¸**")
        st.bar_chart(genre_day.T)
    else:
        st.info("ì¥ë¥´ë³„ ë¶„ì„ì„ ìœ„í•´ 'ì¥ë¥´' ì»¬ëŸ¼ì´ í¬í•¨ëœ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")

    # ===============================
    # ìš”ì¼ë³„ ì´ ë§¤ì¶œì•¡ ì‹œê°í™”
    # ===============================
    st.markdown("### **ìš”ì¼ë³„ ì´ ë§¤ì¶œì•¡**")
    total_sales_by_day = df.groupby('ìš”ì¼')['ë§¤ì¶œì•¡'].sum().reindex(weekdays)
    st.bar_chart(total_sales_by_day)
    
except Exception as e:
    st.error(f"ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
    st.markdown("ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜, URL ì£¼ì†Œ ë˜ëŠ” íŒŒì¼ í˜•ì‹ì— ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
